Windows LDAP Zero-Click RCE
===========================

**Author:**    Hyperion Gray Security Research Team  
**Date:**      2025-11-16  
**CVE:**       [CVE-2024-49112](https://nvd.nist.gov/vuln/detail/CVE-2024-49112)  
**Advisory:**  https://socprime.com/blog/cve-2024-49112-exploitation-attempts-detection/  
**Tested on:** Windows Server 2019, 2022 (Domain Controllers)

Demo
----

This exploit demonstrates the vulnerability with proper LDAP protocol implementation.
Uses benign payloads for research purposes.

Discussion
----------

CVE-2024-49112 is a critical zero-click remote code execution vulnerability affecting 
Windows LDAP services on Domain Controllers. With a CVSS score of 9.8, this 
vulnerability represents a severe threat to Active Directory infrastructure.

The exploit demonstrates:
- Proper ASN.1 BER encoding of LDAP messages
- Valid LDAP Bind and Search requests
- Attribute manipulation that could trigger the vulnerability
- Complete LDAP protocol interaction with target

**Attack Requirements:**
- Network access to LDAP service (typically port 389 or 636 for LDAPS)
- No user interaction or authentication required (zero-click)
- Target must be a Windows Domain Controller with LDAP service running

**Technical Details:**
The vulnerability exists in the Windows LDAP service's handling of specially crafted
search requests. By sending malicious LDAP packets with crafted attribute descriptions,
an attacker can trigger memory corruption:

1. Attacker sends LDAP SearchRequest with crafted attributes
2. lsass.exe LDAP parser reads attribute length fields
3. Integer overflow occurs in buffer size calculation
4. Small buffer allocated but large data copied
5. Heap corruption in LDAP service memory space
6. Control flow hijacked leading to code execution with SYSTEM privileges

The attack can be launched from any network position where LDAP traffic can reach
the Domain Controller, making Internet-exposed DCs particularly vulnerable.

**Impact:**
- Complete domain compromise
- Credential theft from Active Directory
- Lateral movement to all domain-joined systems
- Persistent backdoor access to corporate networks

Usage
-----

    $ python3 exploit_skeleton.py TARGET_HOST [TARGET_PORT]

Where `TARGET_HOST` is the IP address or hostname of the Windows Domain Controller
and `TARGET_PORT` defaults to 389.

Example:

    $ python3 exploit_skeleton.py 192.168.1.10
    $ python3 exploit_skeleton.py 192.168.1.10 389

The exploit will:
1. Connect to LDAP service on target
2. Send anonymous bind request
3. Send crafted LDAP search request (benign version)
4. Display exploitation theory and attack flow
5. Show what weaponization would require

**Note:** This uses benign attribute values for research. A weaponized version would
require precise length overflow calculations, heap grooming, and ROP chains.

Mitigation
----------

- Apply Microsoft security updates immediately (November 2024 or later)
- Restrict LDAP service access to trusted networks only
- Never expose Domain Controllers directly to the Internet
- Monitor LDAP traffic for suspicious patterns
- Deploy SIEM rules for CVE-2024-49112 exploitation attempts
- Consider LDAP signing and channel binding enforcement

Detection
---------

SOC Prime provides Sigma detection rules for this CVE. Monitor for:
- Unusual LDAP request patterns
- LDAP requests with abnormal packet sizes
- Crashes in LDAP service (lsass.exe)
- Unexpected network connections from Domain Controllers

References
----------

- https://socprime.com/blog/cve-2024-49112-exploitation-attempts-detection/
- https://nvd.nist.gov/vuln/detail/CVE-2024-49112
- https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49112
- SafeBreach Labs PoC disclosure
