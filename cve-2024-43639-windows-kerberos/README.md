Windows Kerberos KDC Proxy RCE
===============================

**Author:**    Hyperion Gray Security Research Team  
**Date:**      2025-11-16  
**CVE:**       [CVE-2024-43639](https://nvd.nist.gov/vuln/detail/CVE-2024-43639)  
**Advisory:**  https://www.zerodayinitiative.com/blog/2025/3/3/cve-2024-43639  
**Tested on:** Windows Server 2019, 2022 (KDC Proxy enabled)

Demo
----

This exploit demonstrates the vulnerability with proper Kerberos protocol implementation.
The payload is benign and won't trigger actual exploitation.

Discussion
----------

CVE-2024-43639 is a critical remote code execution vulnerability affecting Microsoft 
Windows servers configured as Kerberos Key Distribution Center (KDC) Proxy Protocol 
servers. The vulnerability stems from an integer overflow and improper validation of 
message lengths when processing Kerberos responses in the KDC Proxy service.

The exploit demonstrates:
- Proper ASN.1 DER encoding of Kerberos messages (AS-REQ and AS-REP)
- KKDCP (Kerberos KDC Proxy Protocol) HTTP request structure
- Length field manipulation that triggers integer overflow
- Complete attack flow from initial connection to exploitation theory

**Attack Requirements:**
- No authentication required
- Target must have an internet-facing KDC Proxy endpoint
- Typically found on Windows Server instances using Remote Desktop Gateway or DirectAccess

**Technical Details:**
The vulnerability exists in `kpssvc.dll` where the KDC Proxy fails to properly validate
the 4-byte length field in Kerberos responses forwarded over HTTPS. When an attacker 
controls the KDC server response, they can cause integer overflow in buffer allocation:

1. KDC Proxy reads 4-byte length prefix from response
2. If length is 0xFFFFFFFF - offset, adding offset causes wrap to small value
3. Small buffer allocated but large data is copied
4. Heap corruption occurs, allowing control flow hijack
5. RCE with SYSTEM privileges on the KDC Proxy server

Usage
-----

    $ python3 exploit_skeleton.py TARGET_HOST TARGET_PORT

Where `TARGET_HOST` is the Windows Server running KDC Proxy and `TARGET_PORT` is 
typically 443 (HTTPS).

Example:

    $ python3 exploit_skeleton.py 192.168.1.100 443

The exploit will:
1. Build a valid Kerberos AS-REQ with proper ASN.1 encoding
2. Create KKDCP HTTP POST request
3. Generate crafted Kerberos response (benign length for demo)
4. Display exploitation theory and attack flow
5. Demonstrate connection to target (no actual exploitation)

**Note:** This uses benign payload values for research purposes. A weaponized version
would require precise length calculations, heap grooming, and ROP chains.

Mitigation
----------

- Apply Microsoft's November 2024 security updates for all Windows Server versions
- Restrict KDC Proxy endpoint access to trusted networks only
- Monitor for suspicious KDC Proxy traffic patterns
- Scan for exposed `/KdcProxy` endpoints in IIS

References
----------

- https://www.zerodayinitiative.com/blog/2025/3/3/cve-2024-43639
- https://cybersecuritynews.com/windows-kdc-proxy-rce-vulnerability/
- https://gbhackers.com/windows-kdc-proxy-rce-vulnerability/
- https://www.cve.news/cve-2024-43639/
