ProxyShell CVE-2021-34473
=========================

**Author:**    Hyperion Gray Security Team  
**Date:**      2024-12-15  
**CVE:**       [CVE-2021-34473](https://nvd.nist.gov/vuln/detail/CVE-2021-34473), [CVE-2021-34523](https://nvd.nist.gov/vuln/detail/CVE-2021-34523), [CVE-2021-31207](https://nvd.nist.gov/vuln/detail/CVE-2021-31207)  
**Advisory:**  https://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell  
**Tested on:** Microsoft Exchange Server 2016, 2019  

Discussion
----------

ProxyShell is actually a chain of three vulnerabilities in Microsoft Exchange Server that, when combined, allow for remote code execution as SYSTEM. The exploit chain consists of:

1. **CVE-2021-34473** - Pre-auth path confusion leading to ACL bypass
2. **CVE-2021-34523** - Elevation of privilege on Exchange PowerShell backend
3. **CVE-2021-31207** - Post-auth arbitrary file write leading to RCE

These vulnerabilities were disclosed at Pwn2Own 2021 and actively exploited in the wild before patches were available.

**Impact:**
- Remote Code Execution as SYSTEM
- Complete server compromise
- Access to all mailboxes
- Lateral movement opportunities

**Affected Versions:**
- Exchange Server 2013
- Exchange Server 2016
- Exchange Server 2019

## Prerequisites

- Python 3.x
- Required Python packages (see requirements.txt)
- Target running vulnerable Exchange Server
- Network access to Exchange Autodiscover service

## Installation

Install dependencies:

    $ pip install -r requirements.txt

## Usage

### Check if Target is Vulnerable

    $ python3 exploit.py --target mail.example.com --check

### Exploit for Web Shell

    $ python3 exploit.py --target mail.example.com --email user@example.com --shell

This will:
1. Exploit the vulnerability chain
2. Write a web shell to the server
3. Display the web shell URL

### Exploit for Command Execution

    $ python3 exploit.py --target mail.example.com --email user@example.com --command "whoami"

### Interactive Shell Mode

    $ python3 exploit.py --target mail.example.com --email user@example.com --interactive

This provides an interactive command shell on the target server.

## How It Works

The exploit chain works as follows:

1. **Path Confusion (CVE-2021-34473)**: 
   - Exploit path normalization in Autodiscover to bypass authentication
   - Access backend resources without proper authentication
   - Uses explicit logon with a valid email address to proxy requests

2. **Privilege Escalation (CVE-2021-34523)**:
   - Exploit PowerShell remoting to gain elevated privileges
   - Use Exchange's PowerShell backend with elevated context

3. **Arbitrary File Write (CVE-2021-31207)**:
   - Use Export-Mailbox cmdlet to write arbitrary files
   - Write a web shell to a web-accessible location
   - Achieve remote code execution

Example exploit flow:
```
Attacker → Autodiscover Endpoint → Path Confusion → Backend Access → PowerShell Remoting → Export Mailbox → Write Webshell → RCE
```

## Web Shell Access

After successful exploitation, the web shell will be accessible at:

    https://mail.example.com/aspnet_client/shell.aspx

Execute commands:

    $ curl -k "https://mail.example.com/aspnet_client/shell.aspx?cmd=whoami"

## Detection and Mitigation

### Mitigation

- Apply Microsoft security updates from May-July 2021
- Disable Autodiscover if not required
- Implement network segmentation
- Monitor Exchange servers for suspicious activity
- Use Microsoft Exchange Emergency Mitigation Service (EEMS)

### Detection

Monitor for:
- Unusual requests to `/autodiscover/autodiscover.json` with `X-AnchorMailbox` header
- PowerShell remoting activity from web processes
- Suspicious file writes to web directories
- Creation of ASPX files in `aspnet_client` or other web-accessible directories
- Unusual Export-Mailbox activity

**Log Locations:**
- IIS logs: `%SystemDrive%\inetpub\logs\LogFiles\`
- Exchange logs: `%ExchangeInstallPath%\Logging\`
- Windows Event Logs: Application and System logs

## Security Notice

**This is for educational and authorized penetration testing purposes only.**
Using this exploit against systems without explicit permission is illegal.
ProxyShell was actively exploited by ransomware groups and nation-state actors.

## References

- https://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell
- https://peterjson.medium.com/reproducing-the-proxyshell-pwn2own-exploit-49743a4ea9a1
- https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34473
- https://www.microsoft.com/security/blog/2021/08/26/proxyshell-vulnerabilities-and-your-exchange-server/
