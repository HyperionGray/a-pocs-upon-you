ProxyLogon (CVE-2021-26855)
===========================

**Original Discovery:** Orange Tsai (DEVCORE Research Team)  
**Adapted by:**         Hyperion Gray Security Research Team  
**Date:**               2021-03-02 (disclosure) / 2024-11-16 (adaptation)  
**CVE:**                [CVE-2021-26855](https://nvd.nist.gov/vuln/detail/CVE-2021-26855)  
**CVSS Score:**         9.1 (Critical)  
**Advisory:**           https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26855  
**Tested on:**          Microsoft Exchange Server 2013, 2016, 2019

Overview
--------

CVE-2021-26855, known as "ProxyLogon", is a critical server-side request forgery (SSRF) vulnerability in Microsoft Exchange Server. This vulnerability is part of a chain of four zero-day vulnerabilities (collectively known as "ProxyLogon") that were actively exploited by the HAFNIUM threat group and other attackers in early 2021.

The vulnerability allows an unauthenticated attacker to send arbitrary HTTP requests and authenticate as the Exchange server via the Exchange Control Panel (ECP) backend. By exploiting this SSRF vulnerability, attackers can bypass authentication and gain access to Exchange resources, including the ability to read emails, access mailboxes, and potentially execute code on the server.

ProxyLogon is particularly dangerous because it affects the Exchange Control Panel's proxy functionality, allowing attackers to make requests to internal Exchange services that should only be accessible to authenticated users. The vulnerability has been used in widespread attacks against organizations worldwide, including government agencies, defense contractors, and private companies.

Affected Versions
----------------

**Vulnerable Exchange Versions:**
- Microsoft Exchange Server 2013 (all Cumulative Updates)
- Microsoft Exchange Server 2016 (all Cumulative Updates prior to March 2021)
- Microsoft Exchange Server 2019 (all Cumulative Updates prior to March 2021)

**Patched Versions:**
- Exchange Server 2013: April 2021 Security Update (KB5000871)
- Exchange Server 2016: March 2021 Security Update (KB5000871)
- Exchange Server 2019: March 2021 Security Update (KB5000871)

**Systems at Risk:**
- On-premises Exchange servers exposed to the internet
- Exchange servers accessible via Outlook Web Access (OWA)
- Hybrid Exchange deployments
- Exchange servers behind reverse proxies or load balancers

**Note:** Exchange Online (Office 365) was not affected by this vulnerability as Microsoft patched cloud services before public disclosure.

Technical Details
----------------

The ProxyLogon vulnerability exists in the Exchange Control Panel (ECP) backend's proxy functionality. The vulnerability allows an attacker to abuse the ECP's legitimate proxy feature to forward requests to internal Exchange services while bypassing authentication.

**Vulnerability Mechanism:**
1. **ECP Proxy Abuse:** Attacker sends crafted request to ECP endpoint
2. **Authentication Bypass:** ECP proxy forwards request without proper validation
3. **Internal Service Access:** Request reaches internal Exchange services as authenticated
4. **SSRF Exploitation:** Attacker can access arbitrary internal endpoints
5. **Data Exfiltration:** Access to mailboxes, configuration, and sensitive data

**Technical Flow:**
```
1. Attacker Request → /ecp/DDI/DDIService.svc/GetObject
2. ECP Proxy → Forwards to internal Exchange services
3. Authentication Context → ECP service account context used
4. Internal Access → Full access to Exchange Web Services (EWS)
5. Data Access → Mailbox content, user information, configuration
```

**Exploitation Characteristics:**
- **Unauthenticated:** No credentials required for initial access
- **Remote:** Exploitable over HTTP/HTTPS
- **High Impact:** Full mailbox access and potential code execution
- **Stealthy:** Can be difficult to detect in logs
- **Chainable:** Often used with other vulnerabilities for full compromise

**Attack Vectors:**

1. **Direct Internet Exposure:**
   - Exchange servers directly accessible from internet
   - Common in small to medium organizations
   - Easily discoverable through search engines

2. **Outlook Web Access (OWA):**
   - Attacks through OWA login pages
   - Bypasses web application firewalls
   - Targets /owa/ and /ecp/ endpoints

3. **Reverse Proxy Configurations:**
   - Attacks through reverse proxies
   - Load balancer misconfigurations
   - SSL termination points

**Common Attack Patterns:**
- Email exfiltration and surveillance
- Credential harvesting from mailboxes
- Lateral movement preparation
- Web shell installation for persistence
- Configuration data extraction

Installation
-----------

Install required dependencies:

```bash
pip install requests urllib3 beautifulsoup4 lxml
```

For advanced features:
```bash
pip install exchangelib  # Exchange Web Services library
pip install pytz        # Timezone handling
```

Usage
-----

### Vulnerability Detection

Test Exchange servers for ProxyLogon vulnerability:

```bash
# Basic vulnerability test
python exploit.py -t https://mail.example.com

# Test with verbose output
python exploit.py -t https://mail.example.com -v

# Test multiple targets
python exploit.py -f exchange_servers.txt

# Test with custom timeout
python exploit.py -t https://mail.example.com --timeout 30
```

### Advanced Detection

```bash
# Test specific ECP endpoints
python exploit.py -t https://mail.example.com --test-ecp

# Check Exchange version
python exploit.py -t https://mail.example.com --version-check

# Test with proxy
python exploit.py -t https://mail.example.com --proxy http://proxy:8080

# Disable SSL verification (for testing)
python exploit.py -t https://mail.example.com --no-ssl-verify
```

### Information Gathering

```bash
# Enumerate Exchange information
python exploit.py -t https://mail.example.com --enumerate

# Check for other Exchange vulnerabilities
python exploit.py -t https://mail.example.com --check-all-vulns

# Extract Exchange configuration
python exploit.py -t https://mail.example.com --config-dump
```

### Exploitation Mode

**WARNING:** Only use against systems you own or have explicit permission to test.

```bash
# List available mailboxes
python exploit.py -t https://mail.example.com --exploit --list-mailboxes

# Read specific mailbox
python exploit.py -t https://mail.example.com --exploit --read-mailbox user@example.com

# Search for sensitive emails
python exploit.py -t https://mail.example.com --exploit --search-emails "password"

# Download mailbox data
python exploit.py -t https://mail.example.com --exploit --download-mailbox user@example.com
```

### Batch Operations

```bash
# Mass scanning with output
python exploit.py -f targets.txt -o results.json

# Scan IP ranges
python exploit.py --ip-range 192.168.1.0/24 --port 443

# Continuous monitoring
python exploit.py -t https://mail.example.com --monitor --interval 3600
```

Detection
---------

**Web Server Log Analysis:**
```bash
# Look for ProxyLogon attack patterns in IIS logs
findstr /i "DDI/DDIService" C:\inetpub\logs\LogFiles\W3SVC1\*.log
findstr /i "GetObject" C:\inetpub\logs\LogFiles\W3SVC1\*.log
findstr /i "/ecp/" C:\inetpub\logs\LogFiles\W3SVC1\*.log

# Check for suspicious User-Agent strings
findstr /i "python" C:\inetpub\logs\LogFiles\W3SVC1\*.log
findstr /i "curl" C:\inetpub\logs\LogFiles\W3SVC1\*.log
```

**Exchange Log Monitoring:**
```powershell
# Check Exchange HTTP proxy logs
Get-Content "C:\Program Files\Microsoft\Exchange Server\V15\Logging\HttpProxy\Ecp\*.log" | Select-String "DDI"

# Monitor EWS logs for suspicious activity
Get-Content "C:\Program Files\Microsoft\Exchange Server\V15\Logging\Ews\*.log" | Select-String "GetFolder\|FindItem"

# Check for unusual mailbox access patterns
Get-MessageTrackingLog -Start (Get-Date).AddDays(-7) | Where-Object {$_.EventId -eq "DELIVER"}
```

**Network-based Detection:**
- Monitor HTTP/HTTPS requests to /ecp/ endpoints
- Look for requests to DDI/DDIService.svc/GetObject
- Detect unusual patterns in Exchange Web Services requests
- Monitor for requests with suspicious User-Agent strings
- Watch for large data transfers from Exchange servers

**Security Tools:**
- Microsoft Exchange On-premises Mitigation Tool (EOMT)
- Microsoft Safety Scanner for Exchange
- Custom PowerShell scripts for log analysis
- SIEM rules for ProxyLogon detection

**Indicators of Compromise:**
- Unusual requests to /ecp/DDI/DDIService.svc/GetObject
- Requests to Exchange Web Services without authentication
- Large data downloads from Exchange servers
- New files in Exchange installation directories
- Suspicious PowerShell execution on Exchange servers
- Unusual network connections from Exchange processes

Mitigation
----------

### Immediate Actions

1. **Apply Microsoft Security Updates:**
   ```powershell
   # Check current Exchange version
   Get-ExchangeServer | Format-List Name,Edition,AdminDisplayVersion
   
   # Download and install March 2021 Security Update
   # KB5000871 for Exchange 2016/2019
   # KB5000871 for Exchange 2013
   ```

2. **Use Microsoft Exchange On-premises Mitigation Tool (EOMT):**
   ```powershell
   # Download EOMT from Microsoft
   # Run the tool to apply temporary mitigations
   .\ExchangeMitigations.ps1 -FullPathToMSI "C:\Temp\ExchangeMitigations.msi"
   
   # Verify mitigations are applied
   .\ExchangeMitigations.ps1 -ShowMitigations
   ```

3. **Implement URL Rewrite Rules (Temporary Mitigation):**
   ```xml
   <!-- Add to web.config in ECP virtual directory -->
   <system.webServer>
     <rewrite>
       <rules>
         <rule name="Block ProxyLogon" stopProcessing="true">
           <match url=".*" />
           <conditions>
             <add input="{REQUEST_URI}" pattern="/ecp/DDI/" />
           </conditions>
           <action type="CustomResponse" statusCode="403" />
         </rule>
       </rules>
     </rewrite>
   </system.webServer>
   ```

4. **Network-level Blocking:**
   ```bash
   # Block specific URLs at firewall/WAF level
   # Block requests to /ecp/DDI/DDIService.svc/GetObject
   # Block requests with suspicious patterns
   
   # Example nginx configuration
   location ~* /ecp/DDI/ {
       return 403;
   }
   ```

### Long-term Security Measures

**Exchange Security Hardening:**
- Keep Exchange servers updated with latest security patches
- Implement multi-factor authentication for all admin accounts
- Use least privilege principles for Exchange service accounts
- Regular security assessments and penetration testing
- Monitor Exchange logs for suspicious activities

**Network Security:**
- Implement Web Application Firewall (WAF) with Exchange-specific rules
- Use reverse proxy with proper security configurations
- Network segmentation to isolate Exchange servers
- VPN access for administrative functions
- Regular vulnerability scanning

**Access Controls:**
- Restrict internet access to Exchange servers where possible
- Implement IP whitelisting for administrative access
- Use certificate-based authentication where applicable
- Regular review of Exchange permissions and roles
- Implement privileged access management (PAM)

**Monitoring and Response:**
- Deploy Security Information and Event Management (SIEM)
- Set up alerts for suspicious Exchange activities
- Regular log analysis and threat hunting
- Incident response procedures for Exchange compromises
- Backup and recovery procedures testing

Real-World Impact
----------------

ProxyLogon has been one of the most significant Exchange vulnerabilities:

**HAFNIUM Campaign (Early 2021):**
- State-sponsored threat group attributed to China
- Targeted thousands of organizations worldwide
- Focused on government, defense, and private sector
- Used ProxyLogon for initial access and data exfiltration

**Widespread Exploitation:**
- Over 60,000 Exchange servers initially vulnerable
- Attacks observed within hours of public disclosure
- Multiple threat groups adopted the exploits
- Ransomware groups incorporated into attack chains

**Affected Sectors:**
- Government agencies and military organizations
- Defense contractors and aerospace companies
- Healthcare organizations and hospitals
- Financial institutions and banks
- Educational institutions and universities
- Small and medium businesses with Exchange servers

**Attack Consequences:**
- Email surveillance and data exfiltration
- Credential harvesting and lateral movement
- Web shell installation for persistent access
- Ransomware deployment in some cases
- Intellectual property theft
- Compromise of sensitive communications

**Response and Recovery:**
- Emergency patching campaigns by organizations
- Microsoft released detection and mitigation tools
- CISA issued emergency directives for federal agencies
- Widespread incident response and forensic investigations
- Long-term monitoring for persistent threats

References
----------

- [Microsoft Security Update CVE-2021-26855](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26855)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2021-26855)
- [CISA Emergency Directive 21-02](https://www.cisa.gov/news-events/directives/emergency-directive-21-02)
- [Microsoft Exchange Server Vulnerabilities Mitigations](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)
- [DEVCORE ProxyLogon Research](https://blog.orange.tw/2021/08/proxylogon-a-new-attack-surface-on-ms-exchange-part-1.html)
- [Volexity HAFNIUM Analysis](https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities/)
- [FireEye ProxyLogon Analysis](https://www.fireeye.com/blog/threat-research/2021/03/detection-response-to-hafnium-exchange-attacks.html)

Legal Notice
-----------

This tool is provided for educational and authorized security testing purposes only.
Unauthorized access to computer systems is illegal and may violate local, state, federal,
or international laws. Always obtain explicit written permission before testing any system
you do not own.

ProxyLogon has been used in numerous criminal attacks and state-sponsored espionage
campaigns. Use of this tool against systems without permission may result in severe
legal consequences. Users are solely responsible for compliance with all applicable laws.

This tool should only be used by security professionals for legitimate security testing,
research, and educational purposes in controlled environments.